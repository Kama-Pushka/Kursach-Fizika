#	THIS FILE IS FOR on_actions SPECIFICALLY FOR THE chinese TAGs

on_actions = { # Общекитайские мехи
	
	# ROOT is new controller, FROM is old controller, FROM.FROM is state ID. 
	on_state_control_changed = { # china_integrate_province
		effect = {
			if = {
				limit = { is_in_array = { global.chinese_state = FROM.FROM } }
				ROOT = { 
					if = {
						limit = { FROM.FROM = { NOT = { is_core_of = PREV } } }
						activate_targeted_decision = { target = FROM.FROM.china_capital_of_province decision = china_integrate_province }
						if = {
							limit = { NOT = { is_in_array = { chinese_integrate_province_state_map = FROM.FROM:china_capital_of_province.id } } }
							for_each_loop = {
								array = FROM.FROM.china_capital_of_province:chinese_province
								value = state
								
								add_to_array = { chinese_integrate_province_state_map = state }
							}
						}
					}
				}
				FROM = {
					if = {
						limit = { 
							all_of = {
								array = FROM.FROM.chinese_province
								value = state
								
								NOT = { controls_state = var:state }
							} 
						}
						remove_targeted_decision = { target = FROM.FROM.china_capital_of_province decision = china_integrate_province }
						if = {
							limit = { is_in_array = { chinese_integrate_province_state_map = FROM.FROM:china_capital_of_province.id } }
							for_each_loop = {
								array = FROM.FROM.china_capital_of_province:chinese_province
								value = state
								
								remove_from_array = { chinese_integrate_province_state_map = state }
							}
						}
					}
				}
				log = "[GetDateText]: [FROM.FROM.GetName] [FROM.FROM.GetID]: check china_integrate_province decision trigger (ROOT: [ROOT.GetTag] FROM: [FROM.GetTag])"
			}
		}
	}
	
	# ROOT is attacker, FROM is defender
	on_war_relation_added = { # attack_against_communists
		effect = {
			if = {
				limit = {
					check_variable = { NW_attack_against_communists > 0 }
					FROM = { has_government = communism }
				}
				set_temp_variable = { enemy = FROM }
				set_attack_against_communists_bonus = yes
			}
			else_if = {
				limit = {
					FROM = { check_variable = { NW_attack_against_communists > 0 } }
					has_government = communism
				}
				FROM = {
					set_temp_variable = { enemy = ROOT }
					set_attack_against_communists_bonus = yes
				}
			}
			
			if = { # TODO_ZATYK
				limit = { 
					OR = { 
						tag = JAP 
						tag = CHI 
					} 
					FROM = { 
						OR = { 
							tag = JAP 
							AND = { 
								tag = CHI 
								is_in_faction = no 
							} 
						}
					} 
				}
				CHI = {
					country_event = { id = NWzatyk.0 days = 10 } # Скрытое создание объединенного китайского фронта
				}
			}
		}
	}
}

on_actions = { # Китайские страны, с небольшим кол-вом экшонов

	### EHB ###
	
	on_startup = {
		effect = {
			if = {
				limit = {
					has_start_date < 1936.01.02
				}
				EHB = {
					country_event = { id = hebei.4 days = 2 }
					country_event = { id = hebei.5 days = 192 }
				}
			}
		}	
	}
	
	# THIS is country that has just gotten into a war.
	# ROOT is capitulated country, FROM is winner
	on_capitulation = {
		effect = {
			if = {
				limit = {
					ROOT = { tag = KUM }
				}
				ROOT = {
				    760 = { remove_core_of = KUM }
					drop_cosmetic_tag = yes
				}
			}
			if = {
				limit = {
					ROOT = { tag = KAS }
				}
				ROOT = {
				    619 = { remove_core_of = KAS }
					1122 = { remove_core_of = KAS }
					drop_cosmetic_tag = yes
				}
			}
			
			#ГВ-Китай	TODO старый кал
			if = {
				limit = {
					FROM = {
						WTT_is_chinese_warlord = yes
					}
					ROOT = {
						tag = CHI
					}
				}
# ПОЧИНИТЬ ПОТОМ				
				FROM = {
#					load_focus_tree = china_nationalist_focus
					set_cosmetic_tag = CHI_warlord_leader
				}
				ROOT = {
					every_core_state = {
						remove_core_of = PREV
						add_core_of = FROM
					}
				}
			}
			if = {
				limit = {
					FROM = { tag = event_target:new_leader }
					ROOT = { tag = event_target:old_leader }
				}
				drop_cosmetic_tag = yes 
				set_cosmetic_tag = CHI
				remove_ideas = CHI_illegal_regime
				clear_global_event_target = WTT_current_china_leader
				save_global_event_target_as = WTT_current_china_leader
			}	
			if = {
				limit = {
					has_civil_war = no
					ROOT = { WTT_is_chinese_warlord = yes }
					FROM = { tag = CHI }
				}
				ROOT = {
					every_core_state = {
						remove_core_of = PREV
					}
				}
				FROM = {
					annex_country = {
						target = ROOT
						transfer_troops = no
					}
				}
			}
		}
	}
	
	#ROOT is winner #FROM is loser
	on_peaceconference_ended = {
		effect = {
			#CHI annex PRC after cgw	TODO старый кал
			if = {
				limit = {
					FROM = {
						tag = PRC
						has_country_flag = PRC_north_western_government_flag
					}
					ROOT = {
						OR = {
							tag = CHI
							tag = JAP
						}
					}
					CHI = { is_in_faction_with = JAP }
				}
				PRC = { clr_country_flag = PRC_north_western_government_flag }
				CHI = {
					annex_country = {
						target = PRC
						transfer_troops = yes
					}
				}
			}
		}
	}
}